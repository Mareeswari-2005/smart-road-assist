<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanic Dashboard - Smart Road Assistance</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; }
        .header { background: #4ecdc4; color: white; padding: 20px; position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.2rem; }
        .status-toggle { display: flex; align-items: center; gap: 8px; }
        .toggle { position: relative; width: 50px; height: 25px; background: #ccc; border-radius: 15px; cursor: pointer; }
        .toggle.active { background: #27ae60; }
        .toggle-slider { position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle.active .toggle-slider { transform: translateX(25px); }
        .logout-btn { background: #ff4757; border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; }
        .container { padding: 20px; max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-number { font-size: 1.8rem; font-weight: bold; color: #4ecdc4; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: #666; }
        .section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .section h3 { margin-bottom: 15px; color: #333; font-size: 1.1rem; }
        .request-card { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #4ecdc4; }
        .request-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .service-badge { background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; }
        .btn { background: #4ecdc4; color: white; border: none; padding: 12px 20px; border-radius: 10px; font-size: 14px; cursor: pointer; margin: 5px; width: 100%; }
        .btn:active { transform: scale(0.95); }
        .btn.danger { background: #ff4757; }
        .btn.success { background: #27ae60; }
        .active-job { background: #e8f5e8; border-left: 5px solid #27ae60; }
        .hidden { display: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; }
        .nav-item { text-align: center; color: #666; text-decoration: none; font-size: 12px; }
        .nav-item.active { color: #4ecdc4; }
        .nav-item .icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
        .notification { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .notification.new { background: #d4edda; border-color: #c3e6cb; }
        .toast { position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 15px 20px; border-radius: 8px; z-index: 1001; transform: translateX(100%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
        .toast.info { background: #3498db; }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üîß Mechanic Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="status-toggle">
                    <span style="font-size: 12px;">Available</span>
                    <div class="toggle" id="statusToggle" onclick="toggleAvailability()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="todayJobs">0</div>
                <div class="stat-label">Today's Jobs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEarnings">‚Çπ0</div>
                <div class="stat-label">Earnings</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedJobs">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rating">5.0</div>
                <div class="stat-label">Rating</div>
            </div>
        </div>

        <div id="activeJob" class="section hidden">
            <h3>üîß Active Job</h3>
            <div class="request-card active-job" id="activeJobCard">
                <!-- Active job details -->
            </div>
        </div>

        <div id="notifications" class="section hidden">
            <h3>üîî New Requests</h3>
            <div id="notificationsList"></div>
        </div>

        <div class="section">
            <h3>üìã Available Requests</h3>
            <div id="requestsList">
                <p style="text-align: center; color: #666; padding: 20px;">Set yourself as available to see requests</p>
            </div>
        </div>

        <div class="section">
            <h3>üìä Recent Jobs</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="#" class="nav-item active" onclick="showHome()">
            <span class="icon">üè†</span>
            Home
        </a>
        <a href="#" class="nav-item" onclick="showEarnings()">
            <span class="icon">üí∞</span>
            Earnings
        </a>
        <a href="#" class="nav-item" onclick="showHistory()">
            <span class="icon">üìã</span>
            History
        </a>
        <a href="#" class="nav-item" onclick="showProfile()">
            <span class="icon">üë§</span>
            Profile
        </a>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let currentMechanic;
        let isAvailable = false;
        let activeJobId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Check for saved credentials first
            const savedEmail = localStorage.getItem('savedEmail');
            const savedPassword = localStorage.getItem('savedPassword');
            const deviceId = localStorage.getItem('deviceId');
            
            if (savedEmail && savedPassword && deviceId) {
                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: savedEmail,
                            password: savedPassword,
                            deviceId: deviceId
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.user.userType === 'mechanic') {
                        sessionStorage.setItem('token', result.token);
                        sessionStorage.setItem('user', JSON.stringify(result.user));
                        
                        currentMechanic = result.user;
                        
                        socket = io();
                        socket.emit('join-room', currentMechanic._id);
                        
                        socket.on('new-request', (data) => {
                            console.log('New request received:', data);
                            showNotification(data);
                            loadAvailableRequests();
                        });
                        
                        socket.on('request-cancelled-broadcast', (data) => {
                            if (data.mechanicId === currentMechanic._id) {
                                showRealTimeNotification(`üö´ Trip Cancelled`, `${data.customerName} cancelled the ride`, 'cancelled');
                                
                                if (activeJobId === data.requestId) {
                                    document.getElementById('activeJob').classList.add('hidden');
                                    activeJobId = null;
                                    stopLocationTracking();
                                }
                                
                                loadAvailableRequests();
                                loadDashboardData();
                            }
                        });
                        
                        socket.on('mechanic-notification', (data) => {
                            if (data.forMechanicId === currentMechanic._id) {
                                console.log('Fallback notification received:', data);
                                showNotification(data);
                                loadAvailableRequests();
                            }
                        });
                        
                        socket.on('new-general-request', (data) => {
                            console.log('General request received:', data);
                            if (isAvailable) {
                                showNotification(data);
                                loadAvailableRequests();
                            }
                        });
                        
                        loadDashboardData();
                        loadAvailableRequests();
                        loadJobHistory();
                        checkActiveJob();
                        return;
                    }
                } catch (error) {
                    console.log('Auto-login failed:', error);
                    localStorage.removeItem('savedEmail');
                    localStorage.removeItem('savedPassword');
                    localStorage.removeItem('savedUserType');
                }
            }
            
            const token = sessionStorage.getItem('token');
            const user = sessionStorage.getItem('user');
            
            if (!token || !user) {
                window.location.href = '/mobile-login';
                return;
            }
            
            currentMechanic = JSON.parse(user);
            
            if (currentMechanic.userType !== 'mechanic') {
                window.location.href = '/mobile-user';
                return;
            }
            
            socket = io();
            socket.emit('join-room', currentMechanic._id);
            
            socket.on('new-request', (data) => {
                console.log('New request received:', data);
                showNotification(data);
                loadAvailableRequests();
            });
            
            socket.on('request-cancelled', (data) => {
                console.log('Request cancelled:', data);
                showRealTimeNotification(`üö´ Trip Cancelled`, `Customer cancelled their request`, 'cancelled');
                
                // If this was the active job, clear it and stop location tracking
                if (activeJobId === data.requestId) {
                    document.getElementById('activeJob').classList.add('hidden');
                    activeJobId = null;
                    stopLocationTracking();
                }
                
                loadAvailableRequests();
                loadDashboardData();
            });
            
            socket.on('mechanic-notification', (data) => {
                if (data.forMechanicId === currentMechanic._id) {
                    console.log('Fallback notification received:', data);
                    showNotification(data);
                    loadAvailableRequests();
                }
            });
            
            socket.on('request-cancelled-broadcast', (data) => {
                console.log('Cancellation received:', data);
                console.log('Current mechanic ID:', currentMechanic._id);
                console.log('Data mechanic ID:', data.mechanicId);
                showRealTimeNotification(`üö´ Trip Cancelled`, `${data.customerName} cancelled their ${data.serviceType} request`, 'cancelled');
                
                if (activeJobId === data.requestId) {
                    document.getElementById('activeJob').classList.add('hidden');
                    activeJobId = null;
                    stopLocationTracking();
                }
                
                // Remove cancelled request from available requests
                const requestCards = document.querySelectorAll('.request-card');
                requestCards.forEach(card => {
                    if (card.innerHTML.includes(data.requestId)) {
                        card.remove();
                    }
                });
                
                loadAvailableRequests();
                loadDashboardData();
            });
            
            socket.on('new-general-request', (data) => {
                console.log('General request received:', data);
                if (isAvailable) {
                    showNotification(data);
                    loadAvailableRequests();
                }
            });
            
            loadDashboardData();
            loadAvailableRequests();
            loadJobHistory();
            checkActiveJob();
        });

        async function toggleAvailability() {
            const toggle = document.getElementById('statusToggle');
            isAvailable = !isAvailable;
            
            toggle.classList.toggle('active', isAvailable);
            
            try {
                await fetch('/api/mechanic/availability', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ available: isAvailable })
                });
                
                if (isAvailable) {
                    loadAvailableRequests();
                }
            } catch (error) {
                console.error('Error updating availability:', error);
            }
        }

        async function acceptRequest(requestId) {
            try {
                const response = await fetch(`/api/mechanic/request/${requestId}/accept`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    activeJobId = requestId;
                    showActiveJob(result.request);
                    loadAvailableRequests();
                    startLocationTracking();
                    
                    // Remove the notification
                    const notifications = document.querySelectorAll('.notification');
                    notifications.forEach(notification => {
                        if (notification.innerHTML.includes(requestId)) {
                            notification.remove();
                        }
                    });
                    
                    alert('‚úÖ Request accepted! Customer has been notified.');
                } else {
                    alert(result.message || 'Error accepting request');
                }
            } catch (error) {
                console.error('Error accepting request:', error);
                alert('Error accepting request.');
            }
        }

        async function declineRequest(requestId) {
            try {
                const response = await fetch(`/api/mechanic/request/${requestId}/decline`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Remove the notification
                    const notifications = document.querySelectorAll('.notification');
                    notifications.forEach(notification => {
                        if (notification.innerHTML.includes(requestId)) {
                            notification.remove();
                        }
                    });
                    
                    loadAvailableRequests();
                    alert('‚ùå Request declined.');
                } else {
                    alert(result.message || 'Error declining request');
                }
            } catch (error) {
                console.error('Error declining request:', error);
                alert('Error declining request.');
            }
        }

        async function completeJob(requestId) {
            try {
                const response = await fetch(`/api/mechanic/request/${requestId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    document.getElementById('activeJob').classList.add('hidden');
                    activeJobId = null;
                    stopLocationTracking();
                    loadDashboardData();
                    loadJobHistory();
                }
            } catch (error) {
                alert('Error completing job.');
            }
        }

        function showActiveJob(request) {
            const activeJobCard = document.getElementById('activeJobCard');
            const userName = request.userId?.name || request.user?.name || 'Customer';
            const userPhone = request.userId?.phone || request.user?.phone || 'Phone not available';
            let location = request.locationAddress || request.location || 'Location not specified';
            
            // If location looks like coordinates, convert to address
            if (location.includes(',') && location.split(',').length === 2) {
                const coords = location.split(',');
                const lat = parseFloat(coords[0].trim());
                const lng = parseFloat(coords[1].trim());
                if (!isNaN(lat) && !isNaN(lng)) {
                    getAddressFromCoords(lat, lng).then(address => {
                        if (address) {
                            const locationElement = activeJobCard.querySelector('.location-text');
                            if (locationElement) {
                                locationElement.textContent = address;
                            }
                        }
                    });
                }
            }
            
            activeJobCard.innerHTML = `
                <div class="request-header">
                    <div>
                        <h4>${userName}</h4>
                        <p style="font-size: 14px; color: #666;">üìû ${userPhone}</p>
                    </div>
                    <span class="service-badge">${request.serviceType}</span>
                </div>
                <p style="margin: 10px 0;"><strong>Location:</strong> <span class="location-text">${location}</span></p>
                <p style="margin: 10px 0;"><strong>Description:</strong> ${request.description || 'No description'}</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn success" onclick="completeJob('${request._id}')">‚úÖ Complete</button>
                    <button class="btn" onclick="callCustomer('${userPhone}')">üìû Call</button>
                </div>
            `;
            document.getElementById('activeJob').classList.remove('hidden');
        }
        
        // Convert coordinates to address
        async function getAddressFromCoords(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`);
                const data = await response.json();
                if (data && data.display_name) {
                    return data.display_name;
                }
            } catch (error) {
                console.log('Geocoding failed');
            }
            return null;
        }

        async function loadAvailableRequests() {
            if (!isAvailable) {
                document.getElementById('requestsList').innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Set yourself as available to see requests</p>';
                return;
            }
            
            try {
                const response = await fetch('/api/mechanic/requests', {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayRequests(result.requests);
                }
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        function displayRequests(requests) {
            const requestsList = document.getElementById('requestsList');
            
            if (requests.length === 0) {
                requestsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No requests available</p>';
                return;
            }
            
            requestsList.innerHTML = '';
            
            requests.forEach(request => {
                const userName = request.user?.name || 'Unknown User';
                const card = document.createElement('div');
                card.className = 'request-card';
                
                let location = request.location || 'Location not specified';
                
                // Convert coordinates to address if needed
                if (location.includes(',') && location.split(',').length === 2) {
                    const coords = location.split(',');
                    const lat = parseFloat(coords[0].trim());
                    const lng = parseFloat(coords[1].trim());
                    if (!isNaN(lat) && !isNaN(lng)) {
                        getAddressFromCoords(lat, lng).then(address => {
                            if (address) {
                                const locationElement = card.querySelector('.location-text');
                                if (locationElement) {
                                    locationElement.textContent = address;
                                }
                            }
                        });
                    }
                }
                
                card.innerHTML = `
                    <div class="request-header">
                        <div>
                            <h4>${userName}</h4>
                            <p style="font-size: 12px; color: #666;">${new Date(request.createdAt).toLocaleTimeString()}</p>
                        </div>
                        <span class="service-badge">${request.serviceType}</span>
                    </div>
                    <p style="margin: 8px 0; font-size: 14px;"><strong>Location:</strong> <span class="location-text">${location}</span></p>
                    <p style="margin: 8px 0; font-size: 14px;">${request.description || 'No description'}</p>
                    <button class="btn" onclick="acceptRequest('${request._id}')">Accept Job</button>
                `;
                requestsList.appendChild(card);
            });
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/mechanic/stats', {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('todayJobs').textContent = result.todayJobs || 0;
                    document.getElementById('totalEarnings').textContent = `‚Çπ${result.totalEarnings || 0}`;
                    document.getElementById('completedJobs').textContent = result.completedJobs || 0;
                    document.getElementById('rating').textContent = result.rating || '5.0';
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadJobHistory() {
            try {
                const response = await fetch('/api/mechanic/history', {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayJobHistory(result.jobs);
                }
            } catch (error) {
                console.error('Error loading job history:', error);
            }
        }

        function displayJobHistory(jobs) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (jobs.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No job history</p>';
                return;
            }
            
            jobs.slice(0, 5).forEach(job => {
                const customerName = job.userId?.name || job.user?.name || 'Customer';
                const card = document.createElement('div');
                card.className = 'request-card';
                card.innerHTML = `
                    <div class="request-header">
                        <div>
                            <h4>${customerName}</h4>
                            <p style="font-size: 12px; color: #666;">${new Date(job.createdAt).toLocaleDateString()}</p>
                        </div>
                        <span class="service-badge">${job.serviceType}</span>
                    </div>
                    <p style="font-size: 14px; color: #27ae60;">Status: ${job.status}</p>
                `;
                historyList.appendChild(card);
            });
        }

        async function checkActiveJob() {
            try {
                const response = await fetch('/api/mechanic/active-job', {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.job) {
                    activeJobId = result.job._id;
                    showActiveJob(result.job);
                    startLocationTracking();
                }
            } catch (error) {
                console.error('Error checking active job:', error);
            }
        }

        function showNotification(data) {
            const notificationsDiv = document.getElementById('notifications');
            const notificationsList = document.getElementById('notificationsList');
            
            const notification = document.createElement('div');
            notification.className = 'notification new';
            notification.innerHTML = `
                <h4>üîî New ${data.serviceType} Request</h4>
                <p><strong>Customer:</strong> ${data.customerName}</p>
                <p><strong>Phone:</strong> ${data.customerPhone || 'Not provided'}</p>
                <p><strong>Location:</strong> ${data.location}</p>
                <p><strong>Description:</strong> ${data.description || 'No description'}</p>
                <p><strong>Urgency:</strong> <span style="color: ${data.urgency === 'high' ? '#e74c3c' : data.urgency === 'medium' ? '#f39c12' : '#27ae60'}">${data.urgency}</span></p>
                <p><strong>Estimated Cost:</strong> ‚Çπ${data.estimatedCost || 'TBD'}</p>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn" onclick="acceptRequest('${data.requestId}')">‚úÖ Accept</button>
                    <button class="btn danger" onclick="declineRequest('${data.requestId}')">‚ùå Decline</button>
                </div>
            `;
            
            notificationsList.insertBefore(notification, notificationsList.firstChild);
            notificationsDiv.classList.remove('hidden');
            
            // Auto-remove notification after 30 seconds if not acted upon
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                    if (notificationsList.children.length === 0) {
                        notificationsDiv.classList.add('hidden');
                    }
                }
            }, 30000);
        }

        function callCustomer(phone) {
            window.open(`tel:${phone}`);
        }

        let locationWatcher = null;
        let currentRequestId = null;

        function startLocationTracking() {
            if (!navigator.geolocation || !activeJobId) return;
            
            currentRequestId = activeJobId;
            
            locationWatcher = navigator.geolocation.watchPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    try {
                        // Update mechanic location in database
                        await fetch('/api/mechanic/location', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                            },
                            body: JSON.stringify({ lat, lng })
                        });
                        
                        // Get request details to find user ID
                        const requestResponse = await fetch(`/api/request/${currentRequestId}`, {
                            headers: {
                                'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                            }
                        });
                        
                        if (requestResponse.ok) {
                            const request = await requestResponse.json();
                            
                            // Send real-time location update to user
                            socket.emit('mechanic-location-update', {
                                requestId: currentRequestId,
                                mechanicId: currentMechanic._id,
                                lat: lat,
                                lng: lng,
                                userId: request.userId
                            });
                        }
                        
                    } catch (error) {
                        console.error('Error updating location:', error);
                    }
                },
                (error) => console.error('Location error:', error),
                { 
                    enableHighAccuracy: true, 
                    timeout: 15000, 
                    maximumAge: 5000 
                }
            );
            
            console.log('Location tracking started for request:', currentRequestId);
        }

        function stopLocationTracking() {
            if (locationWatcher) {
                navigator.geolocation.clearWatch(locationWatcher);
                locationWatcher = null;
                currentRequestId = null;
                console.log('Location tracking stopped');
            }
        }

        async function showEarnings() {
            try {
                const response = await fetch('/api/mechanic/earnings', {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.7); display: flex; align-items: center;
                        justify-content: center; z-index: 1000;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 15px; max-width: 400px; width: 90%;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #333; margin: 0;">üí∞ Earnings</h3>
                                <button id="closeEarnings" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 16px; font-weight: bold; color: #27ae60;">‚Çπ${result.todayEarnings || 0}</div>
                                    <div style="font-size: 11px; color: #666;">Today</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 16px; font-weight: bold; color: #3498db;">‚Çπ${result.weekEarnings || 0}</div>
                                    <div style="font-size: 11px; color: #666;">This Week</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 16px; font-weight: bold; color: #f39c12;">‚Çπ${result.monthEarnings || 0}</div>
                                    <div style="font-size: 11px; color: #666;">This Month</div>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 16px; font-weight: bold; color: #e74c3c;">‚Çπ${result.totalEarnings || 0}</div>
                                    <div style="font-size: 11px; color: #666;">Total</div>
                                </div>
                            </div>
                            
                            ${result.recentJobs && result.recentJobs.length > 0 ? `
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                <h4 style="color: #333; margin: 0 0 8px 0; font-size: 14px;">Recent Jobs</h4>
                                ${result.recentJobs.slice(0, 3).map(job => `
                                    <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px;">
                                        <span>${job.serviceType}</span>
                                        <span style="color: #27ae60; font-weight: bold;">‚Çπ${job.actualCost || job.estimatedCost || 0}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : '<p style="text-align: center; color: #666; font-size: 14px;">No completed jobs yet</p>'}
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Add event listener for close button
                    document.getElementById('closeEarnings').addEventListener('click', function() {
                        document.body.removeChild(modal);
                    });
                    
                    // Close on background click
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    });
                } else {
                    alert('Unable to load earnings data');
                }
            } catch (error) {
                console.error('Error loading earnings:', error);
                alert('Error loading earnings data');
            }
        }

        async function showHistory() {
            try {
                const response = await fetch('/api/mechanic/history', {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.7); display: flex; align-items: center;
                        justify-content: center; z-index: 1000;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 15px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #333; margin: 0;">üìã Job History</h3>
                                <button id="closeHistory" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                            </div>
                            
                            ${result.jobs && result.jobs.length > 0 ? 
                                result.jobs.map(job => `
                                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #4ecdc4;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                            <strong style="font-size: 14px;">${job.serviceType}</strong>
                                            <span style="font-size: 12px; color: #666;">${new Date(job.createdAt).toLocaleDateString()}</span>
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Customer: ${job.user?.name || 'Unknown'}</div>
                                        <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Status: <span style="color: ${job.status === 'completed' ? '#27ae60' : '#f39c12'};">${job.status}</span></div>
                                        <div style="font-size: 12px; color: #27ae60; font-weight: bold;">‚Çπ${job.actualCost || job.estimatedCost || 0}</div>
                                    </div>
                                `).join('') 
                                : '<p style="text-align: center; color: #666; padding: 20px;">No job history found</p>'
                            }
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    document.getElementById('closeHistory').addEventListener('click', function() {
                        document.body.removeChild(modal);
                    });
                    
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    });
                } else {
                    alert('Unable to load job history');
                }
            } catch (error) {
                console.error('Error loading history:', error);
                alert('Error loading job history');
            }
        }

        function showProfile() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex; align-items: center;
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 15px; max-width: 400px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #333; margin: 0;">üë§ Profile</h3>
                        <button id="closeProfile" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="width: 60px; height: 60px; background: #4ecdc4; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; color: white; margin-bottom: 10px;">üîß</div>
                        <h4 style="margin: 0; color: #333;">${currentMechanic?.name || 'Mechanic'}</h4>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">${currentMechanic?.email || 'mechanic@example.com'}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="margin-bottom: 8px;"><strong>üìû Phone:</strong> ${currentMechanic?.phone || 'Not provided'}</div>
                        <div style="margin-bottom: 8px;"><strong>üè¢ Type:</strong> ${currentMechanic?.userType || 'Mechanic'}</div>
                        <div><strong>üìÖ Member Since:</strong> ${currentMechanic?.createdAt ? new Date(currentMechanic.createdAt).toLocaleDateString() : 'Recently'}</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="editProfile" style="flex: 1; background: #4ecdc4; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">‚úèÔ∏è Edit</button>
                        <button id="logoutProfile" style="flex: 1; background: #ff4757; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">üö™ Logout</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('closeProfile').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            document.getElementById('editProfile').addEventListener('click', function() {
                alert('Profile editing feature coming soon!');
            });
            
            document.getElementById('logoutProfile').addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    logout();
                }
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        function showHome() {
            // Reset all nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            // Set home as active
            document.querySelectorAll('.nav-item')[0].classList.add('active');
            // No action needed - already on home view
        }

        function logout() {
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            localStorage.removeItem('savedEmail');
            localStorage.removeItem('savedPassword');
            localStorage.removeItem('savedUserType');
            window.location.href = '/mobile-login';
        }

        // Real-time notification like Uber/Ola
        function showRealTimeNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background: ${type === 'cancelled' ? '#ff4757' : '#4ecdc4'};
                color: white; padding: 15px 25px; border-radius: 25px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 2000; font-weight: 600;
                animation: slideDown 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 16px; margin-bottom: 5px;">${title}</div>
                    <div style="font-size: 14px; opacity: 0.9;">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>